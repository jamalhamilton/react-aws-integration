{"ast":null,"code":"import _classCallCheck from\"/var/www/interverify/frontend/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/var/www/interverify/frontend/node_modules/@babel/runtime/helpers/esm/createClass\";import _possibleConstructorReturn from\"/var/www/interverify/frontend/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";import _assertThisInitialized from\"/var/www/interverify/frontend/node_modules/@babel/runtime/helpers/esm/assertThisInitialized\";import _createSuper from\"/var/www/interverify/frontend/node_modules/@babel/runtime/helpers/esm/createSuper\";import _inherits from\"/var/www/interverify/frontend/node_modules/@babel/runtime/helpers/esm/inherits\";import React from\"react\";import{Container,Row,Col,Button,ProgressBar}from\"react-bootstrap\";import Webcam from\"react-webcam\";import AWS from\"aws-sdk\";import QRCode from\"qrcode.react\";import{Redirect,withRouter}from\"react-router\";import config from\"../config/front_config\";import{Divider}from\"rsuite\";var videoConstraints={width:1280,height:720,facingMode:{exact:\"environment\"}};var IDAuth=/*#__PURE__*/function(_React$Component){_inherits(IDAuth,_React$Component);var _super=_createSuper(IDAuth);// webcamRef = React.useRef(null);\nfunction IDAuth(props){var _this;_classCallCheck(this,IDAuth);_this=_super.call(this);var query=new URLSearchParams(props.location.search);var userToken=query.get('token');if(!userToken){window.location.href='/';return _possibleConstructorReturn(_this);}var authStep=parseInt(userToken.substr(-1))-8;userToken=userToken.substr(0,userToken.length-1);_this.webcamRef=React.createRef();_this.state={userToken:userToken,authStep:authStep,verifyURL:config.siteUrl+config.api.verifyID+'?token='+userToken+'9',photo_source:'',photo_target:'',blob:'',resultMsg:'',msgColor:'black',resultBtnStatus:0,uploadingProgress:0};_this.photoCapture=_this.photoCapture.bind(_assertThisInitialized(_this));_this.comparePhoto=_this.comparePhoto.bind(_assertThisInitialized(_this));_this.navToVerify=_this.navToVerify.bind(_assertThisInitialized(_this));return _this;}_createClass(IDAuth,[{key:\"componentDidMount\",value:function componentDidMount(){var that=this;var userToken=this.state.userToken;fetch(config.api.getUser,{headers:{'Content-Type':'application/json'},method:\"POST\",body:JSON.stringify({token:userToken})}).then(function(res){return res.json();}).then(function(data){if(data.status){that.state.photo_source=data.data.id+'_face.jpg';that.state.photo_target=data.data.id+'_id.jpg';}});}},{key:\"photoCapture\",value:function photoCapture(){var that=this;var _this$state=this.state,authStep=_this$state.authStep,userToken=_this$state.userToken;var imageSrc=this.webcamRef.current.getScreenshot();if(!imageSrc){this.setState({msgColor:'red',resultMsg:'Camera is not connected!!'});return;}/////////////////////////////////        \n// that.setState({\n//     authStep: authStep + 1,\n// });\n// return;\n/////////////////////////////////\nvar _this$state2=this.state,photo_source=_this$state2.photo_source,photo_target=_this$state2.photo_target;AWS.config.update({accessKeyId:config.aws.accessKey,secretAccessKey:config.aws.secretKey,region:config.aws.region});var bucket=new AWS.S3({params:{Bucket:config.aws.bucket}});var fileName=photo_source;if(authStep===1)fileName=photo_target;imageSrc=this.dataURItoBlob(imageSrc);var imgFile=new File([imageSrc],fileName);// var params = { Key: imgFile.name, ContentType: imgFile.type, Body: imgFile, ServerSideEncryption: 'None' };\nvar params={Key:imgFile.name,ContentType:\"image/jpeg\",Body:imgFile};that.setState({msgColor:'black',resultMsg:'',uploadingProgress:0});bucket.putObject(params,function(err,data){if(!err){// alert('Uploading done!!!');\nvar verifyType={verify_photo:fileName};if(authStep===1)verifyType={verify_idcard:fileName};verifyType.token=userToken;fetch(config.api.updateUserInfo,{headers:{'Content-Type':'application/json'},method:\"POST\",body:JSON.stringify(verifyType)}).then(function(res){return res.json();}).then(function(data){if(data.status){that.setState({msgColor:'black',resultMsg:'Uploading done.'});console.log('-------- uploaded: ',data);setTimeout(function(){that.setState({authStep:0,resultMsg:'',resultBtnStatus:0,uploadingProgress:0});},1000);}console.log('data',data.data);});}else{alert(err.message);return false;}}).on('httpUploadProgress',function(progress){console.log('---- uploading progress: ',progress);console.log('---- uploading progress: ',progress.loaded/progress.total*100);var percent=parseInt(progress.loaded/progress.total*100);that.setState({uploadingProgress:percent});});}},{key:\"navToVerify\",value:function navToVerify(){var that=this;var userToken=this.state.userToken;fetch(config.api.getUser,{headers:{'Content-Type':'application/json'},method:\"POST\",body:JSON.stringify({token:userToken})}).then(function(res){return res.json();}).then(function(data){if(data.status){var errMsg='';if(!data.data.verify_idcard)errMsg=\"You didn't upload id card photo.\";if(!data.data.verify_photo)errMsg=\"You didn't upload face photo.\";if(errMsg){that.setState({msgColor:'red',resultMsg:errMsg});return;}that.setState({photo_source:data.data.verify_photo,photo_target:data.data.verify_idcard});that.comparePhoto();// setTimeout(function () {\n//     that.setState({\n//         authStep: 2,       //authStep + 1,\n//         resultMsg: '',\n//         resultBtnStatus: 0,\n//         uploadingProgress: 0\n//     });\n// }, 1000);\n}else{that.setState({msgColor:'red',resultMsg:'Server connection failed.'});}});}},{key:\"dataURItoBlob\",value:function dataURItoBlob(dataURI){// convert base64/URLEncoded data component to raw binary data held in a string\nvar binary=atob(dataURI.split(',')[1]);var mimeString=dataURI.split(',')[0].split(':')[1].split(';')[0];// console.log('-- mimeString: ', mimeString);\nvar array=[];for(var i=0;i<binary.length;i++){array.push(binary.charCodeAt(i));}return new Blob([new Uint8Array(array)],{type:mimeString});}},{key:\"comparePhoto\",value:function comparePhoto(){var that=this;var _that$state=that.state,resultBtnStatus=_that$state.resultBtnStatus,userToken=_that$state.userToken;if(resultBtnStatus){that.setState({authStep:0,resultBtnStatus:0});return;}var bucket=config.aws.bucket;// the bucketname without s3://\n// const awsConfig = new AWS.Config({\n//     accessKeyId: config.aws.accessKey,\n//     secretAccessKey: config.aws.secretKey,\n//     region: config.aws.region\n// })\nvar _this$state3=this.state,photo_source=_this$state3.photo_source,photo_target=_this$state3.photo_target;AWS.config.update({accessKeyId:config.aws.accessKey,secretAccessKey:config.aws.secretKey,region:config.aws.region});var client=new AWS.Rekognition();var params={SourceImage:{S3Object:{Bucket:bucket,Name:photo_source}},TargetImage:{S3Object:{Bucket:bucket,Name:photo_target}},SimilarityThreshold:70};console.log('-- compare 0');try{client.compareFaces(params,function(err,response){if(err){console.log(err,err.stack);// an error occurred                    \nthat.setState({resultBtnStatus:1,msgColor:'red',resultMsg:'You didn\\'t upload exact personal photo.'});return;}if(!response.FaceMatches.length){that.setState({resultBtnStatus:1,msgColor:'red',resultMsg:'User and ID is not matched!'});return;}console.log('-- compare 1');console.log('--- response.faceMatches: ',response.FaceMatches);response.FaceMatches.forEach(function(data){console.log('-- compare 2 : ',data);var position=data.Face.BoundingBox;var similarity=data.Similarity;console.log(\"The face at: \".concat(position.Left,\", \").concat(position.Top,\" matches with \").concat(similarity,\" % confidence\"));fetch(config.api.updateUserInfo,{headers:{'Content-Type':'application/json'},method:\"POST\",body:JSON.stringify({token:userToken,verify_result:similarity})}).then(function(res){return res.json();}).then(function(data){if(data.status){console.log('-------- uploaded: ',data);that.setState({resultBtnStatus:1,msgColor:'black',resultMsg:'User\\'s similarity is : '+similarity+'.'});}console.log('data',data.data);});});// for response.faceDetails\n});}catch(err){that.setState({resultBtnStatus:1,msgColor:'red',resultMsg:'You didn\\'t upload exact personal photo.'});console.log(err);}}},{key:\"render\",value:function render(){var authStep=this.state.authStep;return/*#__PURE__*/React.createElement(Container,{style:{textAlign:\"center\"}},authStep===0&&/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Row,{style:{marginTop:50}},/*#__PURE__*/React.createElement(Col,null,/*#__PURE__*/React.createElement(\"h1\",null,\"Step 2. Verify Your Information\"))),/*#__PURE__*/React.createElement(Divider,null),/*#__PURE__*/React.createElement(Row,{style:{marginTop:30}},/*#__PURE__*/React.createElement(Col,null,/*#__PURE__*/React.createElement(\"h4\",null,\"Your Face Photo\"),/*#__PURE__*/React.createElement(Webcam,{videoConstraints:videoConstraints,screenshotFormat:\"image/jpeg\",ref:this.webcamRef}),/*#__PURE__*/React.createElement(\"p\",null,/*#__PURE__*/React.createElement(Button,{variant:\"primary\",onClick:this.photoCapture},\"Upload\"))),authStep===0&&/*#__PURE__*/React.createElement(Col,null,/*#__PURE__*/React.createElement(\"h4\",null,\"Your ID card\"),/*#__PURE__*/React.createElement(QRCode,{value:this.state.verifyURL,size:256,level:'Q',includeMargin:true}),/*#__PURE__*/React.createElement(\"p\",null,this.state.verifyURL),/*#__PURE__*/React.createElement(\"p\",null,\"Please scan this link and upload id card on your phone.\"))),/*#__PURE__*/React.createElement(Divider,null),/*#__PURE__*/React.createElement(Row,{style:{marginTop:30}},/*#__PURE__*/React.createElement(Col,null,/*#__PURE__*/React.createElement(Button,{variant:\"primary\",onClick:this.navToVerify},\"Verify Information\"))),this.state.uploadingProgress>0&&/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Row,{style:{marginTop:30}},/*#__PURE__*/React.createElement(Col,null),/*#__PURE__*/React.createElement(Col,null,/*#__PURE__*/React.createElement(ProgressBar,{now:this.state.uploadingProgress,label:this.state.uploadingProgress+'%',animated:true})),/*#__PURE__*/React.createElement(Col,null)))),authStep===1&&/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Row,{style:{marginTop:50}},/*#__PURE__*/React.createElement(Col,null,/*#__PURE__*/React.createElement(\"h1\",null,\"Upload Your ID Card\"))),/*#__PURE__*/React.createElement(Divider,null),/*#__PURE__*/React.createElement(Row,{style:{marginTop:30}},/*#__PURE__*/React.createElement(Col,null,/*#__PURE__*/React.createElement(Webcam,{videoConstraints:videoConstraints,screenshotFormat:\"image/jpeg\",ref:this.webcamRef}))),/*#__PURE__*/React.createElement(Divider,null),/*#__PURE__*/React.createElement(Row,{style:{marginTop:30}},/*#__PURE__*/React.createElement(Col,null,/*#__PURE__*/React.createElement(Button,{variant:\"primary\",onClick:this.photoCapture},\"Upload ID Card\"))),this.state.uploadingProgress>0&&/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Row,{style:{marginTop:30}},/*#__PURE__*/React.createElement(Col,null),/*#__PURE__*/React.createElement(Col,null,/*#__PURE__*/React.createElement(ProgressBar,{now:this.state.uploadingProgress,label:this.state.uploadingProgress+'%',animated:true})),/*#__PURE__*/React.createElement(Col,null)))),authStep===2&&/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Row,{style:{marginTop:50}},/*#__PURE__*/React.createElement(Col,null,/*#__PURE__*/React.createElement(\"h1\",null,\"Step 2. Verify Your Identity\"))),/*#__PURE__*/React.createElement(Divider,null),/*#__PURE__*/React.createElement(Row,{style:{marginTop:30}},/*#__PURE__*/React.createElement(Col,null,/*#__PURE__*/React.createElement(Button,{variant:\"primary\",onClick:this.comparePhoto},this.state.resultBtnStatus?'Upload again':'Verify')))),/*#__PURE__*/React.createElement(Row,{style:{marginTop:30,marginBottom:30,color:this.state.msgColor}},/*#__PURE__*/React.createElement(Col,null,this.state.resultMsg)),this.state.blob!==''&&/*#__PURE__*/React.createElement(\"img\",{src:this.state.blob,alt:\"blob\"}));}}]);return IDAuth;}(React.Component);export default withRouter(IDAuth);","map":{"version":3,"sources":["/var/www/interverify/frontend/src/components/IDAuth.js"],"names":["React","Container","Row","Col","Button","ProgressBar","Webcam","AWS","QRCode","Redirect","withRouter","config","Divider","videoConstraints","width","height","facingMode","exact","IDAuth","props","query","URLSearchParams","location","search","userToken","get","window","href","authStep","parseInt","substr","length","webcamRef","createRef","state","verifyURL","siteUrl","api","verifyID","photo_source","photo_target","blob","resultMsg","msgColor","resultBtnStatus","uploadingProgress","photoCapture","bind","comparePhoto","navToVerify","that","fetch","getUser","headers","method","body","JSON","stringify","token","then","res","json","data","status","id","imageSrc","current","getScreenshot","setState","update","accessKeyId","aws","accessKey","secretAccessKey","secretKey","region","bucket","S3","params","Bucket","fileName","dataURItoBlob","imgFile","File","Key","name","ContentType","Body","putObject","err","verifyType","verify_photo","verify_idcard","updateUserInfo","console","log","setTimeout","alert","message","on","progress","loaded","total","percent","errMsg","dataURI","binary","atob","split","mimeString","array","i","push","charCodeAt","Blob","Uint8Array","type","client","Rekognition","SourceImage","S3Object","Name","TargetImage","SimilarityThreshold","compareFaces","response","stack","FaceMatches","forEach","position","Face","BoundingBox","similarity","Similarity","Left","Top","verify_result","textAlign","marginTop","marginBottom","color","Component"],"mappings":"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","sourcesContent":["import React from \"react\";\r\nimport { Container, Row, Col, Button, ProgressBar } from \"react-bootstrap\";\r\nimport Webcam from \"react-webcam\";\r\nimport AWS from \"aws-sdk\";\r\nimport QRCode from \"qrcode.react\";\r\nimport { Redirect, withRouter } from \"react-router\";\r\n\r\nimport config from \"../config/front_config\";\r\nimport { Divider } from \"rsuite\";\r\n\r\nconst videoConstraints = {\r\n    width: 1280,\r\n    height: 720,\r\n    facingMode: { exact: \"environment\" },\r\n};\r\n\r\nclass IDAuth extends React.Component {\r\n    // webcamRef = React.useRef(null);\r\n\r\n    constructor(props) {\r\n        super();\r\n\r\n        let query = new URLSearchParams(props.location.search);\r\n        let userToken = query.get('token');\r\n\r\n        if (!userToken) {\r\n            window.location.href = '/';\r\n            return;\r\n        }\r\n\r\n        let authStep = parseInt(userToken.substr(-1)) - 8;\r\n        userToken = userToken.substr(0, userToken.length - 1);\r\n\r\n        this.webcamRef = React.createRef();\r\n\r\n        this.state = {\r\n            userToken: userToken,\r\n            authStep: authStep,\r\n\r\n            verifyURL: config.siteUrl + config.api.verifyID + '?token=' + userToken + '9',\r\n\r\n            photo_source: '',\r\n            photo_target: '',\r\n\r\n            blob: '',\r\n\r\n            resultMsg: '',\r\n            msgColor: 'black',\r\n            resultBtnStatus: 0,\r\n\r\n            uploadingProgress: 0,\r\n        };\r\n\r\n        this.photoCapture = this.photoCapture.bind(this);\r\n        this.comparePhoto = this.comparePhoto.bind(this);\r\n        this.navToVerify = this.navToVerify.bind(this);\r\n    }\r\n\r\n    componentDidMount() {\r\n        var that = this;\r\n        var { userToken } = this.state;\r\n        fetch(config.api.getUser, {\r\n            headers: { 'Content-Type': 'application/json' },\r\n            method: \"POST\",\r\n            body: JSON.stringify({ token: userToken }),\r\n        }).then(res => res.json()).then(data => {\r\n            if (data.status) {\r\n                that.state.photo_source = data.data.id + '_face.jpg';\r\n                that.state.photo_target = data.data.id + '_id.jpg';\r\n            }\r\n        });\r\n    }\r\n\r\n    photoCapture() {\r\n        var that = this;\r\n        var { authStep, userToken } = this.state;\r\n\r\n        var imageSrc = this.webcamRef.current.getScreenshot();\r\n        if (!imageSrc) {\r\n            this.setState({\r\n                msgColor: 'red',\r\n                resultMsg: 'Camera is not connected!!',\r\n            })\r\n            return;\r\n        }\r\n\r\n        /////////////////////////////////        \r\n        // that.setState({\r\n        //     authStep: authStep + 1,\r\n        // });\r\n        // return;\r\n        /////////////////////////////////\r\n\r\n        var { photo_source, photo_target } = this.state;\r\n\r\n        AWS.config.update({\r\n            accessKeyId: config.aws.accessKey,\r\n            secretAccessKey: config.aws.secretKey,\r\n            region: config.aws.region\r\n        })\r\n        var bucket = new AWS.S3({ params: { Bucket: config.aws.bucket } })\r\n        var fileName = photo_source;\r\n        if (authStep === 1) fileName = photo_target;\r\n\r\n        imageSrc = this.dataURItoBlob(imageSrc);\r\n        var imgFile = new File([imageSrc], fileName);\r\n        // var params = { Key: imgFile.name, ContentType: imgFile.type, Body: imgFile, ServerSideEncryption: 'None' };\r\n        var params = { Key: imgFile.name, ContentType: \"image/jpeg\", Body: imgFile };\r\n        that.setState({\r\n            msgColor: 'black',\r\n            resultMsg: '',\r\n            uploadingProgress: 0,\r\n        })\r\n        bucket.putObject(params, function (err, data) {\r\n            if (!err) {\r\n                // alert('Uploading done!!!');\r\n                var verifyType = { verify_photo: fileName };\r\n                if (authStep === 1) verifyType = { verify_idcard: fileName };\r\n                verifyType.token = userToken\r\n                fetch(config.api.updateUserInfo, {\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    method: \"POST\",\r\n                    body: JSON.stringify(verifyType),\r\n                }).then(res => res.json()).then(data => {\r\n                    if (data.status) {\r\n                        that.setState({\r\n                            msgColor: 'black',\r\n                            resultMsg: 'Uploading done.',\r\n                        });\r\n                        console.log('-------- uploaded: ', data);\r\n                        setTimeout(function () {\r\n                            that.setState({\r\n                                authStep: 0,\r\n                                resultMsg: '',\r\n                                resultBtnStatus: 0,\r\n                                uploadingProgress: 0\r\n                            });\r\n                        }, 1000);\r\n                    }\r\n                    console.log('data', data.data)\r\n                });\r\n            } else {\r\n                alert(err.message);\r\n                return false;\r\n            }\r\n        }).on('httpUploadProgress', function (progress) {\r\n            console.log('---- uploading progress: ', progress);\r\n            console.log('---- uploading progress: ', progress.loaded / progress.total * 100);\r\n\r\n            var percent = parseInt(progress.loaded / progress.total * 100);\r\n            that.setState({\r\n                uploadingProgress: percent\r\n            })\r\n        });\r\n    }\r\n\r\n    navToVerify() {\r\n        var that = this;\r\n        var { userToken } = this.state;\r\n\r\n        fetch(config.api.getUser, {\r\n            headers: { 'Content-Type': 'application/json' },\r\n            method: \"POST\",\r\n            body: JSON.stringify({\r\n                token: userToken\r\n            }),\r\n        }).then(res => res.json()).then(data => {\r\n            if (data.status) {\r\n                var errMsg = ''\r\n                if (!data.data.verify_idcard) errMsg = \"You didn't upload id card photo.\";\r\n                if (!data.data.verify_photo) errMsg = \"You didn't upload face photo.\";\r\n                if (errMsg) {\r\n                    that.setState({\r\n                        msgColor: 'red',\r\n                        resultMsg: errMsg,\r\n                    });\r\n                    return;\r\n                }\r\n                that.setState({\r\n                    photo_source: data.data.verify_photo,\r\n                    photo_target: data.data.verify_idcard,\r\n                })\r\n                that.comparePhoto();\r\n                // setTimeout(function () {\r\n                //     that.setState({\r\n                //         authStep: 2,       //authStep + 1,\r\n                //         resultMsg: '',\r\n                //         resultBtnStatus: 0,\r\n                //         uploadingProgress: 0\r\n                //     });\r\n                // }, 1000);\r\n            } else {\r\n                that.setState({\r\n                    msgColor: 'red',\r\n                    resultMsg: 'Server connection failed.',\r\n                });\r\n            }\r\n        });\r\n\r\n    }\r\n\r\n    dataURItoBlob(dataURI) {\r\n        // convert base64/URLEncoded data component to raw binary data held in a string\r\n        var binary = atob(dataURI.split(',')[1]);\r\n        var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];\r\n\r\n        // console.log('-- mimeString: ', mimeString);\r\n        var array = [];\r\n        for (var i = 0; i < binary.length; i++) {\r\n            array.push(binary.charCodeAt(i));\r\n        }\r\n        return new Blob([new Uint8Array(array)], { type: mimeString });\r\n    }\r\n\r\n    comparePhoto() {\r\n        var that = this;\r\n        var { resultBtnStatus, userToken } = that.state;\r\n        if (resultBtnStatus) {\r\n            that.setState({\r\n                authStep: 0,\r\n                resultBtnStatus: 0,\r\n            })\r\n            return;\r\n        }\r\n        const bucket = config.aws.bucket; // the bucketname without s3://\r\n\r\n        // const awsConfig = new AWS.Config({\r\n        //     accessKeyId: config.aws.accessKey,\r\n        //     secretAccessKey: config.aws.secretKey,\r\n        //     region: config.aws.region\r\n        // })\r\n\r\n        var { photo_source, photo_target } = this.state;\r\n\r\n        AWS.config.update({\r\n            accessKeyId: config.aws.accessKey,\r\n            secretAccessKey: config.aws.secretKey,\r\n            region: config.aws.region\r\n        })\r\n\r\n        const client = new AWS.Rekognition();\r\n        const params = {\r\n            SourceImage: {\r\n                S3Object: {\r\n                    Bucket: bucket,\r\n                    Name: photo_source,\r\n                },\r\n            },\r\n            TargetImage: {\r\n                S3Object: {\r\n                    Bucket: bucket,\r\n                    Name: photo_target,\r\n                },\r\n            },\r\n            SimilarityThreshold: 70,\r\n        };\r\n\r\n        console.log('-- compare 0')\r\n        try {\r\n            client.compareFaces(params, function (err, response) {\r\n                if (err) {\r\n                    console.log(err, err.stack); // an error occurred                    \r\n                    that.setState({\r\n                        resultBtnStatus: 1,\r\n                        msgColor: 'red',\r\n                        resultMsg: 'You didn\\'t upload exact personal photo.'\r\n                    })\r\n                    return;\r\n                }\r\n                if (!response.FaceMatches.length) {\r\n                    that.setState({\r\n                        resultBtnStatus: 1,\r\n                        msgColor: 'red',\r\n                        resultMsg: 'User and ID is not matched!'\r\n                    })\r\n                    return;\r\n                }\r\n                console.log('-- compare 1')\r\n                console.log('--- response.faceMatches: ', response.FaceMatches);\r\n\r\n                response.FaceMatches.forEach((data) => {\r\n                    console.log('-- compare 2 : ', data)\r\n                    let position = data.Face.BoundingBox;\r\n                    let similarity = data.Similarity;\r\n                    console.log(\r\n                        `The face at: ${position.Left}, ${position.Top} matches with ${similarity} % confidence`\r\n                    );\r\n                    fetch(config.api.updateUserInfo, {\r\n                        headers: { 'Content-Type': 'application/json' },\r\n                        method: \"POST\",\r\n                        body: JSON.stringify({\r\n                            token: userToken,\r\n                            verify_result: similarity\r\n                        }),\r\n                    }).then(res => res.json()).then(data => {\r\n                        if (data.status) {\r\n                            console.log('-------- uploaded: ', data);\r\n                            that.setState({\r\n                                resultBtnStatus: 1,\r\n                                msgColor: 'black',\r\n                                resultMsg: 'User\\'s similarity is : ' + similarity + '.'\r\n                            });\r\n                        }\r\n                        console.log('data', data.data)\r\n                    });\r\n                }); // for response.faceDetails\r\n            });\r\n        } catch (err) {\r\n            that.setState({\r\n                resultBtnStatus: 1,\r\n                msgColor: 'red',\r\n                resultMsg: 'You didn\\'t upload exact personal photo.'\r\n            })\r\n            console.log(err);\r\n        }\r\n    }\r\n\r\n    render() {\r\n        let { authStep } = this.state;\r\n\r\n        return (\r\n            <Container style={{ textAlign: \"center\" }}>\r\n                {(authStep === 0) && (\r\n                    <div>\r\n                        <Row style={{ marginTop: 50 }}>\r\n                            <Col>\r\n                                <h1>\r\n                                    Step 2. Verify Your Information\r\n                                </h1>\r\n                            </Col>\r\n                        </Row>\r\n                        <Divider />\r\n                        <Row style={{ marginTop: 30 }}>\r\n                            <Col>\r\n                                <h4>Your Face Photo</h4>\r\n                                <Webcam\r\n                                    videoConstraints={videoConstraints}\r\n                                    screenshotFormat=\"image/jpeg\"\r\n                                    ref={this.webcamRef}\r\n                                />\r\n                                <p>\r\n                                    <Button\r\n                                        variant=\"primary\"\r\n                                        onClick={this.photoCapture}\r\n                                    >\r\n                                        Upload\r\n                                </Button>\r\n                                </p>\r\n                            </Col>\r\n                            {authStep === 0 && (\r\n                                <Col>\r\n                                    <h4>Your ID card</h4>\r\n                                    <QRCode\r\n                                        value={this.state.verifyURL}\r\n                                        size={256}\r\n                                        level={'Q'}\r\n                                        includeMargin={true}\r\n                                    />\r\n                                    <p>{this.state.verifyURL}</p>\r\n                                    <p>Please scan this link and upload id card on your phone.</p>\r\n                                </Col>\r\n                            )}\r\n                        </Row>\r\n                        <Divider />\r\n                        <Row style={{ marginTop: 30 }}>\r\n                            <Col>\r\n                                <Button\r\n                                    variant=\"primary\"\r\n                                    onClick={this.navToVerify}\r\n                                >\r\n                                    Verify Information\r\n                                </Button>\r\n                            </Col>\r\n                        </Row>\r\n                        {this.state.uploadingProgress > 0 && (\r\n                            <div>\r\n                                <Row style={{ marginTop: 30 }}>\r\n                                    <Col></Col>\r\n                                    <Col>\r\n                                        <ProgressBar\r\n                                            now={this.state.uploadingProgress}\r\n                                            label={this.state.uploadingProgress + '%'}\r\n                                            animated\r\n                                        />\r\n                                    </Col>\r\n                                    <Col></Col>\r\n                                </Row>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {(authStep === 1) && (\r\n                    <div>\r\n                        <Row style={{ marginTop: 50 }}>\r\n                            <Col>\r\n                                <h1>\r\n                                    Upload Your ID Card\r\n                                </h1>\r\n                            </Col>\r\n                        </Row>\r\n                        <Divider />\r\n                        <Row style={{ marginTop: 30 }}>\r\n                            <Col>\r\n                                <Webcam\r\n                                    videoConstraints={videoConstraints}\r\n                                    screenshotFormat=\"image/jpeg\"\r\n                                    ref={this.webcamRef}\r\n                                />\r\n                            </Col>\r\n                        </Row>\r\n                        <Divider />\r\n                        <Row style={{ marginTop: 30 }}>\r\n                            <Col>\r\n                                <Button\r\n                                    variant=\"primary\"\r\n                                    onClick={this.photoCapture}\r\n                                >\r\n                                    Upload ID Card\r\n                                </Button>\r\n                            </Col>\r\n                        </Row>\r\n                        {this.state.uploadingProgress > 0 && (\r\n                            <div>\r\n                                <Row style={{ marginTop: 30 }}>\r\n                                    <Col></Col>\r\n                                    <Col>\r\n                                        <ProgressBar\r\n                                            now={this.state.uploadingProgress}\r\n                                            label={this.state.uploadingProgress + '%'}\r\n                                            animated\r\n                                        />\r\n                                    </Col>\r\n                                    <Col></Col>\r\n                                </Row>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                )}\r\n\r\n                {authStep === 2 && (\r\n                    <div>\r\n                        <Row style={{ marginTop: 50 }}>\r\n                            <Col>\r\n                                <h1>Step 2. Verify Your Identity</h1>\r\n                            </Col>\r\n                        </Row>\r\n                        <Divider />\r\n                        <Row style={{ marginTop: 30 }}>\r\n                            <Col>\r\n                                <Button\r\n                                    variant=\"primary\"\r\n                                    onClick={this.comparePhoto}\r\n                                >\r\n                                    {this.state.resultBtnStatus ? 'Upload again' : 'Verify'}\r\n                                </Button>\r\n                            </Col>\r\n                        </Row>\r\n                    </div>\r\n                )}\r\n                <Row style={{ marginTop: 30, marginBottom: 30, color: this.state.msgColor }}>\r\n                    <Col>{this.state.resultMsg}</Col>\r\n                </Row>\r\n                {this.state.blob !== '' &&\r\n                    <img src={this.state.blob} alt=\"blob\" />\r\n                }\r\n            </Container>\r\n        );\r\n    }\r\n}\r\n\r\nexport default withRouter(IDAuth);\r\n"]},"metadata":{},"sourceType":"module"}